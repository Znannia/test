const API_KEYS=["AIzaSyAZRW_d8xXbCSudzTPPQ7pUqcLmH26MeuE"],CHANNEL_ID="UC0usNaN5iwML35qPxASBDWQ";let currentKeyIndex=0;const playlistIds={"Географія":"PLOI77RmcxMp7iQywXcinPbgpl4kTXx_oV","Історія":"PLOI77RmcxMp57Hj3qFR8kv0D1rYs-MJNO","Біблія":"PLOI77RmcxMp6bsY12dqBZ9tdf-EMf6lpY","Україна":"PLOI77RmcxMp7umvhlyP8jIgvCk_9gKUFN","Загальні знання":"PLOI77RmcxMp40BcW7EImRhMEtLFieW9B7","Логіка":"PLOI77RmcxMp69eZQe-B51PXjk-hG123nE","Що зайве":"PLOI77RmcxMp6jhCedjZf7QYOscN3KuMIO","Не програєш":"PLOI77RmcxMp5FIXH2Z9OGFTEhrGQjBi_S"},categoryDescriptions={"Загальні знання":"Перевірте свою ерудицію з тестами на загальні знання! Від історії до науки — ці вікторини ідеальні для дітей і дорослих, щоб весело провести час і дізнатися щось нове разом із родиною. Пройдіть тест прямо зараз!","Біблія":"Зануртеся у світ Святого Письма з вікторинами про Біблію! Перевірте, як добре ви знаєте біблійні сюжети та персонажів разом із сім’єю. Пройдіть тест і поглибте свої знання!","Не програєш":"Готові до сміху та веселощів? Ці вікторини з несподіваними питаннями ідеальні для гри з друзями чи родиною. Дізнайтесь цікаве один про одного та пройдіть тест разом!","Що зайве":"Потренуйте мозок із тестами на пошук зайвого чи подібного разом із родиною! Ці завдання покращують концентрацію та увагу. Прийміть виклик і перевірте свої навички!","Логіка":"Перевірте свою кмітливість із тестами на логіку разом із сім’єю! Ці загадки — чудовий спосіб потренувати розум і весело провести час. Спробуйте розв’язати всі завдання!","Історія":"Досліджуйте минуле з вікторинами про історію, міфи та легенди разом із родиною! Перевірте знання про давні цивілізації й таємничі сюжети. Пройдіть тест і дізнайтесь більше!","Географія":"Мандруйте світом із географічними тестами разом із сім’єю! Від країн до природних чудес — ці вікторини підходять усім, хто любить географію. Перевірте свої знання вже зараз!","Україна":"Поглибте знання про Україну з тестами про її історію та культуру разом із родиною! Дізнайтесь більше про традиції, події та видатних постатей. Пройдіть вікторину прямо зараз!"};async function fetchWithKey(e){try{const t=await fetch(`${e}&key=${API_KEYS[currentKeyIndex]}`);if(!t.ok&&(403===t.status||429===t.status))return currentKeyIndex=(currentKeyIndex+1)%API_KEYS.length,fetchWithKey(e);return t}catch(t){throw t}}async function fetchSubscribers(){const e=document.getElementById("subscribers");if(!e)return;const t="subscribersCount",a="subscribersTime",n=864e5,s=new Date,i=s.getTime(),r=17===s.getHours(),c=localStorage.getItem(t),o=localStorage.getItem(a);if(c&&o&&i-o<n&&!r)return void(e.innerHTML=`Нас уже понад<br><span class="subscribers-count">${c}</span>`);try{const n=await fetchWithKey(`https://www.googleapis.com/youtube/v3/channels?part=statistics&id=${CHANNEL_ID}`);if(!n.ok)throw new Error("Не вдалося отримати дані про підписників");const s=await n.json(),r=s.items[0].statistics.subscriberCount;localStorage.setItem(t,r),localStorage.setItem(a,i.toString()),e.innerHTML=`Нас уже понад<br><span class="subscribers-count">${r}</span>`}catch(t){e.innerHTML="Помилка завантаження підписників"}}async function filterNonShorts(e,t){if(!e.length)return[];if("Логіка"===t)return e;try{const a=await fetchWithKey(`https://www.googleapis.com/youtube/v3/videos?part=contentDetails&id=${e.join(",")}`);if(!a.ok)return e;const n=await a.json(),s=[];return n.items.forEach((t,a)=>{const n=t.contentDetails.duration,i=(n.match(/PT(\d+H)?(\d+M)?(\d+S)?/)||[0,0,0,0]).slice(1).map(e=>parseInt(e)||0),r=i[0]*3600+i[1]*60+i[2];r>=60&&s.push(e[a])}),s}catch(a){return e}}function cleanDescription(e){return e.replace(/#[\wА-Яа-я]+/g,"").replace(/Вітаємо на каналі "Знання для всіх"/gi,"").trim()}async function renderVideos(e,t,a=!1){if(t.innerHTML="",0===e.length)return void(t.innerHTML="<p>Немає доступних відео. Спробуйте пізніше.</p>");const n=document.createElement("script");n.type="application/ld+json";const s={"@context":"https://schema.org","@type":"VideoObject","name":a?"Вікторини та тести для всієї родини - Знання для всіх":`Вікторини з ${t.dataset.category||"Категорії"} - Знання для всіх`,"description":a?"Тести та вікторини з географії, історії, Біблії, України та логіки для всієї родини. Дивіться останні та випадкові відео з YouTube-каналу Знання для всіх!":categoryDescriptions[t.dataset.category]||"Цікаві тести та вікторини для всієї родини!","thumbnailUrl":"https://img.youtube.com/vi/VIDEO_ID/maxresdefault.jpg","uploadDate":"2025-05-01","contentUrl":"https://www.youtube.com/watch?v=VIDEO_ID"};if(e[0]){const i=a?e[0].id.videoId:e[0].snippet.resourceId.videoId;s.thumbnailUrl=`https://img.youtube.com/vi/${i}/maxresdefault.jpg`,s.contentUrl=`https://www.youtube.com/watch?v=${i}`,n.text=JSON.stringify(s),document.head.appendChild(n)}for(const i of e){const r=a?i.id.videoId:i.snippet.resourceId.videoId,c=i.snippet.title,o=`https://img.youtube.com/vi/${r}/maxresdefault.jpg`;let l="";try{const e=await fetchWithKey(`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${r}`);if(e.ok){const t=await e.json();l=cleanDescription(t.items[0].snippet.description)}}catch(e){}const d=document.createElement("div");d.className="video-item",d.innerHTML=`<div class="video-container"><img src="${o}" alt="${c}" class="thumbnail" data-video-id="${r}" loading="lazy"></div><p class="video-title" data-video-id="${r}">${c}${a?' <span class="new">Нове</span>':""}</p><div class="video-actions"><button class="comment-btn">Коментар</button><div class="like-container"><span class="heart${localStorage.getItem(`liked_${r}`)?" liked":""}" data-video-id="${r}">${localStorage.getItem(`liked_${r}`)?"♥":"♡"}</span><span class="like-count" data-video-id="${r}">${localStorage.getItem(`likes_${r}`)||0}</span></div><button class="more-btn" data-video-id="${r}">Більше</button></div><div class="comment-box" style="display:none"><textarea placeholder="Ваш коментар..." rows="4"></textarea><button class="submit-comment">Відправити</button><div class="comment-list"></div></div><div class="description-box" style="display:none" data-video-id="${r}"><p>${l||"Опис недоступний"}</p></div>`,t.appendChild(d);const m=d.querySelector(".comment-list"),g=JSON.parse(localStorage.getItem(`comments_${r}`)||"[]");g.forEach(e=>{const t=document.createElement("p");t.textContent=e,m.appendChild(t)})}t.addEventListener("click",e=>{const a=e.target;if(a.matches(".video-title,.thumbnail")){const n=a.getAttribute("data-video-id"),s=a.closest(".video-item").querySelector(".video-container"),i=s.dataset.playerActive==="true";i||(s.innerHTML=`<iframe src="https://www.youtube.com/embed/${n}?rel=0&autoplay=1" frameborder="0" allowfullscreen loading="lazy"></iframe>`,s.dataset.playerActive="true")}else if(a.matches(".comment-btn")){const e=a.parentElement.nextElementSibling;e.style.display="none"===e.style.display?"block":"none"}else if(a.matches(".submit-comment")){const e=a.previousElementSibling,n=a.closest(".video-item").querySelector(".heart").getAttribute("data-video-id"),s=a.nextElementSibling;if(e.value.trim()){const t=document.createElement("p");t.textContent=e.value.trim(),s.appendChild(t);const a=JSON.parse(localStorage.getItem(`comments_${n}`)||"[]");a.push(e.value.trim()),localStorage.setItem(`comments_${n}`,JSON.stringify(a)),e.value=""}}else if(a.matches(".heart")){const e=a.getAttribute("data-video-id");let t=parseInt(localStorage.getItem(`likes_${e}`)||0);localStorage.getItem(`liked_${e}`)?(t-=1,a.classList.remove("liked"),a.innerHTML="♡",localStorage.removeItem(`liked_${e}`)):(t+=1,a.classList.add("liked"),a.innerHTML="♥",localStorage.setItem(`liked_${e}`,"true")),localStorage.setItem(`likes_${e}`,t),a.nextElementSibling.textContent=t}else if(a.matches(".more-btn")){const e=a.getAttribute("data-video-id"),t=a.parentElement.nextElementSibling.nextElementSibling;"none"===t.style.display?(t.style.display="block",a.textContent="Менше"):(t.style.display="none",a.textContent="Більше")}})}async function fetchLatestVideos(){const e=document.getElementById("latest-videos");if(!e)return;const t="latestVideos",a="latestVideosTime",n=864e5;e.classList.add("loading");const s=localStorage.getItem(t),i=localStorage.getItem(a),r=Date.now();if(s&&i&&r-i<n){const t=JSON.parse(s).filter(e=>e.id&&e.id.videoId&&e.snippet&&e.snippet.title!=="Private video"&&e.snippet.title!=="Deleted video");return await renderVideos(t,e,!0),localStorage.setItem(t,JSON.stringify(t)),void e.classList.remove("loading")}try{const n=await fetchWithKey(`https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${CHANNEL_ID}&maxResults=10&order=date&type=video`);if(!n.ok)throw new Error(`Помилка API: ${n.status}`);const s=await n.json();let i=s.items.filter(e=>e.id&&e.id.videoId&&e.snippet&&e.snippet.title!=="Private video"&&e.snippet.title!=="Deleted video"),r=i.map(e=>e.id.videoId),c=await filterNonShorts(r);if(i=i.filter(e=>c.includes(e.id.videoId)).slice(0,3),0===i.length)return e.innerHTML="<p>Немає доступних відео. Спробуйте пізніше.</p>",void e.classList.remove("loading");localStorage.setItem(t,JSON.stringify(i)),localStorage.setItem(a,r.toString()),await renderVideos(i,e,!0)}catch(t){e.innerHTML=`<p>Помилка завантаження відео: ${t.message}. Спробуйте пізніше.</p>`}finally{e.classList.remove("loading")}}async function fetchRandomVideos(){const e=document.getElementById("random-videos");if(!e)return;const t="randomVideos",a="randomVideosTime",n=864e5;e.classList.add("loading");const s=localStorage.getItem(t),i=localStorage.getItem(a),r=Date.now();if(s&&i&&r-i<n){const t=JSON.parse(s).filter(e=>e.snippet&&e.snippet.resourceId&&e.snippet.resourceId.videoId&&e.snippet.title!=="Private video"&&e.snippet.title!=="Deleted video");return await renderVideos(t,e),localStorage.setItem(t,JSON.stringify(t)),void e.classList.remove("loading")}try{const n=window.innerWidth;let s=15;n>=600&&n<900?s=12:n<600&&(s=9);const i=[],r=Object.keys(playlistIds);for(const t of r){const a=playlistIds[t],n=await fetchWithKey(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet,status&playlistId=${a}&maxResults=50`);if(!n.ok)continue;const s=await n.json(),r=s.items.filter(e=>e.snippet&&e.snippet.resourceId&&e.snippet.resourceId.videoId&&e.snippet.title!=="Private video"&&e.snippet.title!=="Deleted video"&&e.status&&e.status.privacyStatus==="public");i.push(...r)}const c=i.map(e=>e.snippet.resourceId.videoId),o=await filterNonShorts(c),l=i.filter(e=>o.includes(e.snippet.resourceId.videoId));if(l.sort(()=>Math.random()-.5).slice(0,s),0===l.length)return e.innerHTML="<p>Немає доступних відео. Спробуйте пізніше.</p>",void e.classList.remove("loading");localStorage.setItem(t,JSON.stringify(l)),localStorage.setItem(a,r.toString()),await renderVideos(l,e)}catch(t){e.innerHTML=`<p>Помилка завантаження відео: ${t.message}. Спробуйте пізніше.</p>`}finally{e.classList.remove("loading")}}async function fetchCategoryVideos(){const e=document.getElementById("category-videos");if(!e)return;let t=e.dataset.category||"",a=playlistIds[t]||"";if(!t||!(t=new URLSearchParams(window.location.search).get("category")||"",a=playlistIds[t]||"",Object.keys(playlistIds).includes(t))&&window.location.pathname.includes("category.html"))return void window.location.replace("https://www.znannia.online/");const n=document.getElementById("category-title");n&&(n.textContent=t||"Вікторини та тести");const s=document.getElementById("category-description");s&&(s.textContent=categoryDescriptions[t]||"Цікаві тести та вікторини для всієї родини!"),document.title=`Вікторини з ${t||"Категорії"} - Знання для всіх`;const i=document.querySelector('meta[name="description"]');i&&i.setAttribute("content",categoryDescriptions[t]||"Дивіться вікторини та тести з категорії на YouTube-каналі Знання для всіх. Цікаво для всієї родини!");const r=document.querySelector('meta[name="keywords"]')||document.createElement("meta");r.name="keywords",r.content=`знання для всіх, вікторини, тести, ${t||"категорії"}, освіта, Україна, НМТ 2025`,document.head.appendChild(r);const c=document.createElement("link");c.rel="canonical",c.href=window.location.href,document.head.appendChild(c);const o=`categoryVideos_${t}`,l=`categoryVideosTime_${t}`,d=864e5;e.classList.add("loading");const m=localStorage.getItem(o),g=localStorage.getItem(l),h=Date.now();if(m&&g&&h-g<d){let a=JSON.parse(m).filter(e=>e.snippet&&e.snippet.title&&e.snippet.title!=="Private video"&&e.snippet.title!=="Deleted video"&&e.snippet.resourceId&&e.snippet.resourceId.videoId);return 0===a.length?(e.innerHTML="<p>Немає доступних відео.</p>",void e.classList.remove("loading")):(await renderVideos(a,e),localStorage.setItem(o,JSON.stringify(a)),void e.classList.remove("loading"))}try{if(!a)throw new Error("Категорія не знайдена");const n=await fetchWithKey(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet,status&playlistId=${a}&maxResults=50`);if(!n.ok)throw new Error(`Помилка API: ${n.status}`);const s=await n.json();let i=s.items.filter(e=>e.snippet&&e.snippet.resourceId&&e.snippet.resourceId.videoId&&e.snippet.title&&e.snippet.title!=="Private video"&&e.snippet.title!=="Deleted video"&&e.status&&e.status.privacyStatus==="public"),r=i.map(e=>e.snippet.resourceId.videoId),c=await filterNonShorts(r,t);if(i=i.filter(e=>c.includes(e.snippet.resourceId.videoId)),0===i.length){const t=await fetch("/fallback-videos.json");if(t.ok)i=await t.json();else return e.innerHTML="<p>Немає доступних відео.</p>",void e.classList.remove("loading")}localStorage.setItem(o,JSON.stringify(i)),localStorage.setItem(l,h.toString()),await renderVideos(i,e)}catch(t){try{const a=await fetch("/fallback-videos.json");a.ok?await renderVideos(await a.json(),e):e.innerHTML=`<p>Помилка завантаження відео: ${t.message}. Спробуйте пізніше.</p>`}catch(a){e.innerHTML=`<p>Помилка завантаження відео: ${t.message}. Спробуйте пізніше.</p>`}}finally{e.classList.remove("loading")}}document.getElementById("categories-btn")?.addEventListener("click",()=>{const e=document.getElementById("categories-list"),t="none"===e.style.display;e.style.display=t?"block":"none",e.previousElementSibling.setAttribute("aria-expanded",t)}),fetchSubscribers(),document.getElementById("latest-videos")&&fetchLatestVideos(),document.getElementById("random-videos")&&fetchRandomVideos(),document.getElementById("category-videos")&&fetchCategoryVideos();
